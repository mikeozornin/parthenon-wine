<html>

<head>
    <meta charset="utf-8">
    <title>Леонид Парфенов выпил в «Парфеноне»</title>

    <link rel="stylesheet" href="//unpkg.com/leaflet@1.5.1/dist/leaflet.css"/>

    <script src="//yastatic.net/jquery/3.3.1/jquery.min.js"></script>
    <script src="//unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>

    <link rel="stylesheet" href="./styles/winemap.css" />

</head>

<body>
    <div class="wine-map-title">Леонид Парфенов выпил в «Парфеноне»<br/><span class="wine-map-title-subtitle">Те же вина <a href="//mikeozornin.ru/blog/all/vino-iz-parfenona/">в виде таблицы</a></span></div>
    <div class="wine-map" id="mapid"></div>

    <script type="text/javascript">

        function getPopupText(wine) {
            return `<div class='wine-card'>
                        <img class='wine-card-image' src='${wine['wine']['cover-url']}'/>
                        <div class='wine-card-text'>
                            <span class='wine-card-text-title'><a href='${wine['wine']['vivino-url']}' target='_blank'>${wine['wine']['title']}</a> · ${wine['wine']['vivino-rating']} ★</span>
                            <div class='wine-card-text-params'>
                                ${wine['wine']['color']}
                                </br>Регион: ${wine['wine']['region']}
                                </br>Виноград: ${wine['wine']['grape']}
                                </br></br><a href='${wine['release']['video-url']}' target='_blank'>${wine['release']['title']}</a>
                            </div>
                        </div>
                    </div>`;
        }

        if (window.location.search === "?hide-title=1") {
            $(".wine-map-title").hide();
        }

        var mymap = L.map('mapid').setView([25.505, 15.09], 3);

        L.tileLayer('https://a.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="//www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors | Icons <a href="//sergeychikin.ru/365" target="_blank">by Sergey Chikin</a>',
            minZoom: 3,
            maxZoom: 16,
        }).addTo(mymap);


        var wineIcon = L.Icon.extend({
            options: {
                iconSize: [24, 37],
                iconAnchor: [12, 18],
                popupAnchor: [0, -19]
            }
        });

        var sparklingWineIcon = L.Icon.extend({
            options: {
                iconSize: [16, 64],
                iconAnchor: [8, 32],
                popupAnchor: [0, -32]
            }
        });

        const wineTypeIcons = {
            'Красное':            new wineIcon({ iconUrl: './icons/red.svg' }),
            'Белое':              new wineIcon({ iconUrl: './icons/white.svg' }),
            'Оранжевое':          new wineIcon({ iconUrl: './icons/amber.svg' }),
            'Розовое':            new wineIcon({ iconUrl: './icons/rose.svg' }),

            'Красное игристое':   new sparklingWineIcon({ iconUrl: './icons/red-sparkling.svg' }),
            'Белое игристое':     new sparklingWineIcon({ iconUrl: './icons/white-sparkling.svg' }),
            'Оранжевое игристое': new sparklingWineIcon({ iconUrl: './icons/amber-sparkling.svg' }),
            'Розовое игристое':   new sparklingWineIcon({ iconUrl: './icons/rose-sparkling.svg' })
        }

        // $.getJSON("./data.json", function (winesJson) {
        $.getJSON("https://raw.githubusercontent.com/mikeozornin/parthenon-wine/master/data.json", function (winesJson) {
            if (winesJson.wines) {
                winesJson.wines.forEach(function (wineReleaseItem, i, arr) {
                    wineItem = wineReleaseItem['wine'];

                    if (wineItem['lat'] && wineItem['lon']) {
                        var markerIcon = wineTypeIcons[wineItem.color];
                        var marker = L.marker([wineItem.lat, wineItem.lon], { icon: markerIcon }).addTo(mymap);
                        marker.bindPopup(getPopupText(wineReleaseItem));
                    }
                });
            }
        });
    </script>
</body>

</html>
